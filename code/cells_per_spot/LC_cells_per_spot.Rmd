---
title: "LC analyses: cells per spot"
author: "Lukas Weber"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


# Introduction

Investigation of number of cells per spot for each sample.

Using VisiumLIBD outputs generated by Heena Divecha (saved in `/processed-data/VisiumLIBD/`).

Also using preprocessed `SpatialExperiment` objects saved previously.


# Analysis pipeline


## Load preprocessed data

Load preprocessed `SpatialExperiment` objects saved with `LC_preprocessing.Rmd` script.

Note we have one `SpatialExperiment` object per sample, stored in a list.

```{r, message=FALSE}
library(here)
library(SpatialExperiment)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
```

```{r}
# load objects
file_load <- here("outputs/objects/LC_SPE_list.RData")
load(file_load)

# sample names
sample_names <- names(spe_list)
sample_names
```


## Number of cells per spot

Load VisiumLIBD outputs provided by Heena Divecha.

```{r, fig.width = 4.5, fig.height = 3.5}
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  # load VisiumLIBD output
  file_n_cells <- here("processed_data", "VisiumLIBD", sample_names[i], "tissue_spot_counts.csv")
  n_cells <- read_csv(file_n_cells)
  
  # contains all spots including outside tissue
  dim(n_cells)
  head(n_cells)
  
  df <- as.data.frame(cbind(colData(spe), spatialCoords(spe)))
  dim(df)
  ix_keep <- match(rownames(df), n_cells$barcode)
  stopifnot(length(ix_keep) == nrow(df))
  df$n_cells <- n_cells$count[ix_keep]
  
  thresh_high <- 10
  df$n_cells_high <- df$n_cells > thresh_high
  
  # plot histogram
  p <- ggplot(df, aes(x = n_cells)) + 
    geom_histogram(binwidth = 1, color = "black", fill = "navy") + 
    ggtitle(paste0("Cells per spot: ", sample_names[i])) + 
    labs(x = "number of cells") + 
    theme_bw()
  
  print(p)
  
  # plot in spatial coordinates
  p <- ggplot(df, aes(x = y, y = x, color = n_cells_high)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_manual(values = c("gray90", "red")) + 
    ggtitle(paste0("Cells per spot: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}
```


## Session info

```{r}
sessionInfo()
```

