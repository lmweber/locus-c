---
title: "LC analyses: segmented regions"
author: "Lukas Weber"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

Analyses for LC project: analyses within segmented regions containing neurons and white matter.


## Data

Using combined NextSeq and MiSeq reads for LC samples LC_1 and LC_2.


# Analysis

## Load data

Load data from Space Ranger outputs into R and create `SpatialExperiment` objects.

Note that we create a separate `SpatialExperiment` object for each sample, and store these in a list.

```{r, message=FALSE}
library(SpatialExperiment)
library(Matrix)
library(rjson)
library(dplyr)
```

```{r}
sample_names <- c("LC_1", "LC_2")
spe_list <- vector("list", length = length(sample_names))
names(spe_list) <- sample_names

for (i in seq_along(sample_names)) {
  
  # ---------
  # load data
  # ---------
  
  sample_name <- sample_names[i]
  
  # path to Space Ranger output files (either on JHPCE or Mac laptop)
  if (Sys.info()["sysname"] == "Linux") {
    # files on JHPCE cluster
    dir_outputs <- "../outputs/NextSeqMiSeq"
  } else if (Sys.info()["sysname"] == "Darwin") {
    # files on Mac laptop
    dir_outputs <- "~/data/locus-c/outputs/NextSeqMiSeq"
  }
  
  # using "filtered" output files containing only spots over tissue
  dir_matrix <- file.path(dir_outputs, sample_name, "outs", "filtered_feature_bc_matrix")
  
  # barcodes
  file_barcodes <- file.path(dir_matrix, "barcodes.tsv.gz")
  df_barcodes <- read.csv(file_barcodes, sep = "\t", header = FALSE, 
                          col.names = c("barcode_id"))
  # features
  file_features <- file.path(dir_matrix, "features.tsv.gz")
  df_features <- read.csv(file_features, sep = "\t", header = FALSE, 
                          col.names = c("gene_id", "gene_name", "feature_type"))
  # counts
  file_counts <- file.path(dir_matrix, "matrix.mtx.gz")
  counts <- readMM(file = file_counts)
  
  # spatial coordinates
  dir_spatial <- file.path(dir_outputs, sample_name, "outs", "spatial")
  file_tisspos <- file.path(dir_spatial, "tissue_positions_list.csv")
  df_tisspos <- read.csv(file_tisspos, header = FALSE, 
                         col.names=c("barcode_id", "in_tissue", "array_row", "array_col", 
                                     "pxl_col_in_fullres", "pxl_row_in_fullres"))
  
  # image paths
  imagepaths <- file.path(dir_spatial, c("tissue_hires_image.png", "tissue_lores_image.png"))
  
  # spatial scale factors
  file_scale <- file.path(dir_spatial, "scalefactors_json.json")
  scalefactors <- fromJSON(file = file_scale)
  
  # check dimensions
  dim(df_barcodes)
  dim(df_features)
  dim(counts)
  # df_tisspos contains all spots (not filtered) - need to match rows
  dim(df_tisspos)
  
  
  # ------------------------
  # create SpatialExperiment
  # ------------------------
  
  # column data: match barcode IDs in 'df_barcodes' and 'df_tisspos'
  dim(df_barcodes)
  dim(df_tisspos)
  stopifnot(all(df_barcodes$barcode_id %in% df_tisspos$barcode_id))
  
  col_data <- left_join(df_barcodes, df_tisspos, by = "barcode_id")
  rownames(col_data) <- col_data$barcode_id
  dim(col_data)
  head(col_data, 3)
  
  # spatial data
  spatial_data <- col_data[, c("pxl_col_in_fullres", "pxl_row_in_fullres")]
  colnames(spatial_data) <- c("x", "y")
  head(spatial_data, 3)
  
  # include same column names in colData and spatialData for easier plotting
  col_data <- cbind(col_data, spatial_data)
  
  # row data
  row_data <- df_features
  rownames(row_data) <- df_features$gene_id
  head(row_data, 3)
  
  # note: not using image files or scale factors for now
  
  # create object
  spe <- SpatialExperiment(
    rowData = row_data, 
    colData = col_data, 
    spatialData = spatial_data, 
    assays = c(counts = counts), 
    sample_id = sample_names[i]
  )
  
  # store in list
  spe_list[[i]] <- spe
}

spe_list
```


## Quality control (QC) metrics

Calculate quality control (QC) metrics per sample using `scater`.

```{r, message=FALSE}
library(scater)
library(ggplot2)
```

```{r, message=FALSE}
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  # identify mitochondrial genes
  is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
  table(is_mito)
  rowData(spe)$gene_name[is_mito]
  
  # remove any spots with zero reads
  is_zero <- colSums(counts(spe)) == 0
  if (sum(is_zero) > 0) {
    spe <- spe[, !is_zero]
  }
  
  # calculate QC metrics using scater package
  spe <- addPerCellQC(spe, subsets = list(mito = is_mito))
  
  head(colData(spe), 3)
  
  # store in list
  spe_list[[i]] <- spe
}

# check
head(colData(spe_list[[1]]), 3)
sapply(spe_list, dim)
```


## Plot QC metrics

```{r, message=FALSE, fig.width=4.75, fig.height=3.5}
# plot UMI counts
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  p <- ggplot(as.data.frame(colData(spe)), 
              aes(x = y, y = x, color = sum)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_gradient(low = "gray95", high = "navy") + 
    ggtitle(paste0("UMI counts: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}

# plot number of detected genes
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  p <- ggplot(as.data.frame(colData(spe)), 
              aes(x = y, y = x, color = detected)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_gradient(low = "gray95", high = "deeppink3") + 
    ggtitle(paste0("Detected genes: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}

# plot percent mitochondrial reads
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  p <- ggplot(as.data.frame(colData(spe)), 
              aes(x = y, y = x, color = subsets_mito_percent)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_gradient(low = "gray95", high = "darkorange2") + 
    ggtitle(paste0("Percent mitochondrial: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}

# spots with high mitochondrial reads
for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  thresh_mito <- 35
  colData(spe)$mito_high <- colData(spe)$subsets_mito_percent > thresh_mito
  
  p <- ggplot(as.data.frame(colData(spe)), 
              aes(x = y, y = x, color = mito_high)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_manual(values = c("gray95", "red")) + 
    ggtitle(paste0("High mitochondrial percent: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}
```


Spots with high mitochondrial percentages are mostly within the white matter regions, so we leave them.

```{r, message=FALSE}
for (i in seq_along(sample_names)) {
  spe <- spe_list[[i]]
  print(max(colData(spe)$subsets_mito_percent))
}
```


## Segment regions

Segment regions using threshold on number of UMI counts per spot. The region with high UMI counts is assumed to contain the LC neurons, and the region with low UMI counts is white matter.


```{r, message=FALSE, fig.width=4.75, fig.height=3.5}
# select thresholds
thresh_umi <- c(3000, 1500)

for (i in seq_along(sample_names)) {
  
  spe <- spe_list[[i]]
  
  # identify spots above threshold
  colData(spe)$is_high_umi <- colData(spe)$sum > thresh_umi[i]
  spe_list[[i]] <- spe
  
  # plot thresholded regions
  p <- ggplot(as.data.frame(colData(spe)), 
              aes(x = y, y = x, color = is_high_umi)) + 
    geom_point(size = 0.5) + 
    coord_fixed() + 
    scale_y_reverse() + 
    scale_color_manual(values = c("gray95", "red")) + 
    ggtitle(paste0("High UMI counts: ", sample_names[i])) + 
    theme_bw() + 
    theme(panel.grid = element_blank(), 
          axis.title = element_blank(), 
          axis.text = element_blank(), 
          axis.ticks = element_blank())
  
  print(p)
}
```


# Session info

```{r, message=FALSE}
sessionInfo()
```

